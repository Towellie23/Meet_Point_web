{% extends 'base.html' %}

{% block title %}{{ event.title }}{% endblock %}

{% block content %}
<div class="container">
    <h1>{{ event.title }}</h1>

    {% if user.is_authenticated %}
        <a href="{% url 'toggle_favorite' event.id %}" class="btn btn-sm btn-outline-secondary">
            {% if is_favorite %}
                Удалить из избранного
            {% else %}
                Добавить в избранное
            {% endif %}
        </a>
    {% endif %}

    {% if user.is_authenticated and user == event.organizer %}
        {% if not event.is_finished %}
            <a href="{% url 'edit_event' event.id %}" class="btn btn-warning">Редактировать мероприятие</a>
            <a href="{% url 'finish_event' event.id %}" class="btn btn-danger">Завершить мероприятие</a>

        {% else %}
            <span class="badge badge-success">Мероприятие завершено</span>
        {% endif %}
    {% endif %}
    {% if event.headline_image %}
        <div class="mb-4">
          <h3>Заглавное изображение</h3>
          <img src="{{ event.headline_image.url }}" class="img-fluid" alt="Заглавное изображение {{ event.title }}">
        </div>
      {% endif %}
    <p><strong>Описание:</strong> {{ event.description }}</p>
    <p><strong>Дата и время:</strong> {{ event.date|date:"d M Y H:i" }}</p>
    <p><strong>Место встречи:</strong> {{ event.location }}</p>
    <p>
        <strong>Организатор:</strong>
        <a href="{% url 'user_profile' event.organizer.id %}">
        {{ event.organizer.username }}
        </a>
    </p>

    <p>
        <strong>Категории:</strong>
        {% for category in event.categories.all %}
          <span class="badge badge-info">{{ category.name }}</span>
        {% empty %}
          <span>Без категории</span>
        {% endfor %}
    </p>




    {% if event.extra_images.all %}
        <div class="mb-4">
          <h3>Дополнительные изображения</h3>
          <div class="row">
            {% for extra in event.extra_images.all %}
              <div class="col-md-4 mb-3">
                <img src="{{ extra.image.url }}" class="img-fluid" alt="Дополнительное изображение">
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}

    {% if user.is_authenticated %}
        <a href="{% url 'participate_event' event.id %}" class="btn btn-success">
            Зарегистрироваться / Отменить участие
        </a>
    {% else %}
        <p><a href="{% url 'login' %}">Войдите</a>, чтобы принять участие.</p>
    {% endif %}

    <hr>
    <h3>Участники</h3>
    <ul class="list-group">
        {% for participation in participants %}
            <li class="list-group-item">{{ participation.user.username }}</li>
        {% empty %}
            <li class="list-group-item">Пока нет участников.</li>
        {% endfor %}
    </ul>
</div>

<hr>
  <h3>Отзывы</h3>
  {% if event.reviews.all %}
      {% for review in event.reviews.all|dictsortreversed:"created_at" %}
         <div class="card mb-2">
           <div class="card-body">
             <strong>
                 <a href="{% url 'user_profile' review.user.id %}">
                    {{ review.user.username }}
                 </a>
             </strong> &mdash; оценка: <strong>{{ review.rating }}</strong><br>
             <p>{{ review.text }}</p>
             <small class="text-muted">{{ review.created_at|date:"d M Y, H:i" }}</small>
           </div>
         </div>
      {% endfor %}
  {% else %}
      <p>Пока нет отзывов.</p>
  {% endif %}

  {% if user.is_authenticated %}
    <a href="{% url 'add_review' event.id %}" class="btn btn-success">Оставить отзыв</a>
  {% else %}
    <p><a href="{% url 'login' %}">Войдите</a>, чтобы оставить отзыв.</p>
  {% endif %}

<hr>
<h3>Комментарии</h3>
{% if event.comments.all %}
    {% for comment in event.comments.all|dictsortreversed:"created_at" %}
        <div class="alert alert-secondary">
            <strong>
                <a href="{% url 'user_profile' comment.user.id %}">
                    {{ comment.user.username }}
                </a>
            </strong>
            <small class="text-muted">{{ comment.created_at|date:"d M Y, H:i" }}</small>
            <p>{{ comment.text }}</p>
        </div>
    {% endfor %}
{% else %}
    <p>Комментариев пока нет.</p>
{% endif %}

{% if user.is_authenticated %}
    <h4>Оставить комментарий</h4>
    <form method="post" action="{% url 'add_comment' event.id %}">
        {% csrf_token %}
        {{ comment_form.as_p }}
        <button type="submit" class="btn btn-primary">Отправить</button>
    </form>
{% else %}
    <p><a href="{% url 'login' %}">Войдите</a>, чтобы оставить комментарий.</p>
{% endif %}

{% endblock %}

